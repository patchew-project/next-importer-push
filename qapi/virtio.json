##
# = Virtio devices
##

##
# @VirtioType:
#
# An enumeration of Virtio device types.
#
# Since: 6.0
##
{ 'enum': 'VirtioType',
  'data': [ 'unknown', 'virtio-9p', 'virtio-blk', 'virtio-serial',
            'virtio-gpu', 'virtio-input', 'virtio-net', 'virtio-scsi',
            'vhost-user-fs', 'vhost-vsock', 'virtio-balloon', 'virtio-crypto',
            'virtio-iommu', 'virtio-pmem', 'virtio-rng' ]
}

##
# @VirtioInfo:
#
# Information about a given VirtIODevice
#
# @path: VirtIO device canonical path.
#
# @type: VirtIO device type.
#
# Since: 6.0
#
##
{ 'struct': 'VirtioInfo',
  'data': {
    'path': 'str',
    'type': 'VirtioType'
  }
}

##
# @x-debug-query-virtio:
#
# Return the list of all VirtIO devices
#
# Returns: list of @VirtioInfo
#
# Since: 6.0
#
# Example:
#
# -> { "execute": "x-debug-query-virtio" }
# <- { "return": [
#        {
#            "path": "/machine/peripheral-anon/device[3]/virtio-backend",
#            "type": "virtio-net"
#        },
#        {
#            "path": "/machine/peripheral-anon/device[1]/virtio-backend",
#            "type": "virtio-serial"
#        },
#        {
#            "path": "/machine/peripheral-anon/device[0]/virtio-backend",
#            "type": "virtio-blk"
#        }
#      ]
#    }
#
##

{ 'command': 'x-debug-query-virtio', 'returns': ['VirtioInfo'] }

##
# @VirtioStatusEndianness:
#
# Enumeration of endianness for VirtioDevice
#
# Since: 6.0
##
{ 'enum': 'VirtioStatusEndianness',
  'data': [ 'unknown', 'little', 'big' ]
}

##
# @VirtioTransportFeature:
#
# An enumeration of Virtio device transport features, including virtio-ring
#
# Since: 6.0
##

{ 'enum': 'VirtioTransportFeature',
  'data': [ 'notify-on-empty', 'any-layout', 'version-1', 'iommu-platform',
            'ring-packed', 'order-platform', 'sr-iov', 'indirect-desc',
            'event-idx', 'bad-feature' ]
}

##
# @VirtioSerialFeature:
#
# An enumeration of Virtio serial features
#
# Since: 6.0
##

{ 'enum': 'VirtioSerialFeature',
  'data': [ 'size', 'multiport', 'emerg-write' ]
}

##
# @VirtioBlkFeature:
#
# An enumeration of Virtio block features
#
# Since: 6.0
##

{ 'enum': 'VirtioBlkFeature',
  'data': [ 'size-max', 'seg-max', 'geometry', 'ro', 'blk-size', 'topology',
            'mq', 'discard', 'write-zeroes', 'barrier', 'scsi', 'flush',
            'config-wce' ]
}

##
# @VirtioGpuFeature:
#
# An enumeration of Virtio gpu features
#
# Since: 6.0
##

{ 'enum': 'VirtioGpuFeature',
  'data': [ 'virgl', 'edid', 'resource-uuid', 'resource-blob' ]
}

##
# @VirtioNetFeature:
#
# An enumeration of Virtio net features
#
# Since: 6.0
##

{ 'enum': 'VirtioNetFeature',
  'data': [ 'csum', 'guest-csum', 'ctrl-guest-offloads', 'mtu', 'mac',
            'guest-tso4', 'guest-tso6', 'guest-ecn', 'guest-ufo',
            'host-tso4', 'host-tso6', 'host-ecn', 'host-ufo', 'mrg-rxbuf',
            'status', 'ctrl-vq', 'ctrl-rx', 'ctrl-vlan', 'ctrl-rx-extra',
            'guest-announce', 'mq', 'ctrl-mac-addr', 'standby',
            'speed-duplex', 'gso', 'hash-report', 'rss', 'rsc-ext' ]
}

##
# @VirtioScsiFeature:
#
# An enumeration of Virtio scsi features
#
# Since: 6.0
##

{ 'enum': 'VirtioScsiFeature',
  'data': [ 'inout', 'hotplug', 'change', 't10-pi' ]
}

##
# @VirtioBalloonFeature:
#
# An enumeration of Virtio balloon features
#
# Since: 6.0
##

{ 'enum': 'VirtioBalloonFeature',
  'data': [ 'must-tell-host', 'stats-vq', 'deflate-on-oom', 'free-page-hint',
            'page-poison', 'reporting' ]
}

##
# @VirtioIommuFeature:
#
# An enumeration of Virtio iommu features
#
# Since: 6.0
##

{ 'enum': 'VirtioIommuFeature',
  'data': [ 'input-range', 'domain-range', 'map-unmap', 'bypass', 'probe',
            'mmio' ]
}

##
# @VirtioDeviceFeaturesBase:
#
# The common fields that apply to all Virtio devices
#
# @type: virtio device type
# @transport: the list of transport features of the virtio device
# @unknown-features: virtio device features bitmap that have not been decoded
#
# Since: 6.0
##

{ 'struct': 'VirtioDeviceFeaturesBase',
  'data': {
    'type': 'VirtioType',
    'transport': [ 'VirtioTransportFeature' ],
    '*unknown-features': 'uint64'
  }
}

##
# @VirtioDeviceFeaturesOptionsSerial:
#
# The options that apply to Virtio serial device
#
# @features: List of the device features
#
# Since: 6.0
##

{ 'struct': 'VirtioDeviceFeaturesOptionsSerial',
  'data': { 'features': [ 'VirtioSerialFeature' ] }
}

##
# @VirtioDeviceFeaturesOptionsBlk:
#
# The options that apply to Virtio block device
#
# @features: List of the device features
#
# Since: 6.0
##

{ 'struct': 'VirtioDeviceFeaturesOptionsBlk',
  'data': { 'features': [ 'VirtioBlkFeature' ] }
}

##
# @VirtioDeviceFeaturesOptionsGpu:
#
# The options that apply to Virtio GPU device
#
# @features: List of the device features
#
# Since: 6.0
##

{ 'struct': 'VirtioDeviceFeaturesOptionsGpu',
  'data': { 'features': [ 'VirtioGpuFeature' ] }
}

##
# @VirtioDeviceFeaturesOptionsNet:
#
# The options that apply to Virtio net device
#
# @features: List of the device features
#
# Since: 6.0
##

{ 'struct': 'VirtioDeviceFeaturesOptionsNet',
  'data': { 'features': [ 'VirtioNetFeature' ] }
}

##
# @VirtioDeviceFeaturesOptionsScsi:
#
# The options that apply to Virtio SCSI device
#
# @features: List of the device features
#
# Since: 6.0
##

{ 'struct': 'VirtioDeviceFeaturesOptionsScsi',
  'data': { 'features': [ 'VirtioScsiFeature' ] }
}

##
# @VirtioDeviceFeaturesOptionsBalloon:
#
# The options that apply to Virtio balloon device
#
# @features: List of the device features
#
# Since: 6.0
##

{ 'struct': 'VirtioDeviceFeaturesOptionsBalloon',
  'data': { 'features': [ 'VirtioBalloonFeature' ] }
}

##
# @VirtioDeviceFeaturesOptionsIommu:
#
# The options that apply to Virtio IOMMU device
#
# @features: List of the device features
#
# Since: 6.0
##

{ 'struct': 'VirtioDeviceFeaturesOptionsIommu',
  'data': { 'features': [ 'VirtioIommuFeature' ] }
}

##
# @VirtioDeviceFeatures:
#
# A union to define the list of features for a virtio device
#
# Since: 6.0
##

{ 'union': 'VirtioDeviceFeatures',
  'base': 'VirtioDeviceFeaturesBase',
  'discriminator': 'type',
  'data': {
    'virtio-serial': 'VirtioDeviceFeaturesOptionsSerial',
    'virtio-blk': 'VirtioDeviceFeaturesOptionsBlk',
    'virtio-gpu': 'VirtioDeviceFeaturesOptionsGpu',
    'virtio-net': 'VirtioDeviceFeaturesOptionsNet',
    'virtio-scsi': 'VirtioDeviceFeaturesOptionsScsi',
    'virtio-balloon': 'VirtioDeviceFeaturesOptionsBalloon',
    'virtio-iommu': 'VirtioDeviceFeaturesOptionsIommu'
  }
}

##
# @VirtioStatus:
#
# @device-id: VirtIODevice status
#
# @device-endian: VirtIODevice device_endian
#
# @guest-features: VirtIODevice guest_features
#
# @host-features: VirtIODevice host_features
#
# @backend-features: VirtIODevice backend_features
#
# @num-vqs: number of VirtIODevice queues
#
# Since: 6.0
#
##

{ 'struct': 'VirtioStatus',
  'data': {
    'device-id': 'int',
    'device-endian': 'VirtioStatusEndianness',
    'guest-features': 'VirtioDeviceFeatures',
    'host-features': 'VirtioDeviceFeatures',
    'backend-features': 'VirtioDeviceFeatures',
    'num-vqs': 'uint16'
  }
}

##
# @x-debug-virtio-status:
#
# Return the status of virtio device
#
# @path: QOBject path of the VirtIODevice
#
# Returns: status of the VirtIODevice
#
# Since: 6.0
#
# Example:
#
# -> { "execute": "x-debug-virtio-status",
#      "arguments": {
#          "path": "/machine/peripheral-anon/device[1]/virtio-backend"
#      }
#   }
# <- { "return": {
#          "device-endian": "little",
#          "device-id": 3,
#          "backend-features": {
#              "transport": [],
#              "type": "virtio-serial",
#              "features": []
#          },
#          "num-vqs": 64,
#          "guest-features": {
#              "transport": [ "event-idx", "indirect-desc", "version-1" ],
#              "type": "virtio-serial",
#              "features": [ "multiport" ]
#          },
#          "host-features": {
#              "transport": [ "event-idx", "indirect-desc", "bad-feature",
#                             "version-1", "any-layout", "notify-on-empty" ],
#              "type": "virtio-serial",
#              "features": [ "emerg-write", "multiport" ]
#          }
#      }
#  }
#
##

{ 'command': 'x-debug-virtio-status',
  'data': { 'path': 'str' },
  'returns': 'VirtioStatus'
}

##
# @VirtQueueStatus:
#
# Status of a VirtQueue
#
# @device-type: VirtIO device type
#
# @queue-index: VirtQueue queue_index
#
# @inuse: VirtQueue inuse
#
# @vring-num: VirtQueue vring.num
#
# @vring-num-default: VirtQueue vring.num_default
#
# @vring-align: VirtQueue vring.align
#
# @vring-desc: VirtQueue vring.desc
#
# @vring-avail: VirtQueue vring.avail
#
# @vring-used: VirtQueue vring.used
#
# @last-avail-idx: VirtQueue last_avail_idx
#
# @shadow-avail-idx: VirtQueue shadow_avail_idx
#
# @used-idx: VirtQueue used_idx
#
# @signalled-used: VirtQueue signalled_used
#
# @signalled-used-valid: VirtQueue signalled_used_valid
#
# Since: 6.0
#
##

{ 'struct': 'VirtQueueStatus',
  'data': {
    'device-type': 'VirtioType',
    'queue-index': 'uint16',
    'inuse': 'uint32',
    'vring-num': 'int',
    'vring-num-default': 'int',
    'vring-align': 'int',
    'vring-desc': 'uint64',
    'vring-avail': 'uint64',
    'vring-used': 'uint64',
    'last-avail-idx': 'uint16',
    'shadow-avail-idx': 'uint16',
    'used-idx': 'uint16',
    'signalled-used': 'uint16',
    'signalled-used-valid': 'uint16'
  }
}

##
# @x-debug-virtio-queue-status:
#
# Return the status of a given VirtQueue
#
# @path: QOBject path of the VirtIODevice
#
# @queue: queue number to examine
#
# Returns: Status of the VirtQueue
#
# Since: 6.0
#
# Example:
#
# -> { "execute": "x-debug-virtio-queue-status",
#      "arguments": {
#          "path": "/machine/peripheral-anon/device[3]/virtio-backend",
#          "queue": 0
#      }
#   }
# <- { "return": {
#      "signalled-used": 373,
#      "inuse": 0,
#      "vring-align": 4096,
#      "vring-desc": 864411648,
#      "signalled-used-valid": 0,
#      "vring-num-default": 256,
#      "vring-avail": 864415744,
#      "queue-index": 0,
#      "last-avail-idx": 373,
#      "vring-used": 864416320,
#      "used-idx": 373,
#      "device-type": "virtio-net",
#      "shadow-avail-idx": 619,
#      "vring-num": 256
#      }
#    }
#
##

{ 'command': 'x-debug-virtio-queue-status',
  'data': { 'path': 'str', 'queue': 'uint16' },
  'returns': 'VirtQueueStatus'
}

##
# @VirtioRingDescFlags:
#
# An enumeration of the virtio ring descriptor flags
#
# Since: 6.0
#
##

{ 'enum': 'VirtioRingDescFlags',
  'data': [ 'next', 'write', 'indirect', 'avail', 'used' ]
}

##
# @VirtioRingDesc:
#
# @addr: guest physical address of the descriptor data
#
# @len: length of the descriptor data
#
# @flags: descriptor flags
#
# Since: 6.0
#
##

{ 'struct': 'VirtioRingDesc',
  'data': {
    'addr': 'uint64',
    'len': 'uint32',
    'flags': [ 'VirtioRingDescFlags' ]
  }
}

##
# @VirtioQueueElement:
#
# @index: index of the element in the queue
#
# @ndescs: number of descriptors
#
# @descs: list of the descriptors
#
# Since: 6.0
#
##

{ 'struct': 'VirtioQueueElement',
  'data': {
    'index': 'uint32',
    'ndescs': 'uint32',
    'descs': ['VirtioRingDesc']
  }
}

##
# @x-debug-virtio-queue-element:
#
# Return the information about an element queue (by default head)
#
# @path: QOBject path of the VirtIODevice
#
# @queue: queue number to examine
#
# @index: the index in the queue, by default head
#
# Returns: the element information
#
# Since: 6.0
#
# Example:
#
# -> { "execute": "x-debug-virtio-queue-element",
#      "arguments": {
#          "path": "/machine/peripheral-anon/device[3]/virtio-backend",
#          "queue": 0
#      }
#   }
# -> { "return": {
#         "index": 24,
#         "ndescs": 1,
#         "descs": [
#             { "flags": ["write"], "len": 1536, "addr": 2027557376 }
#         ]
#      }
#   }
#
##

{ 'command': 'x-debug-virtio-queue-element',
  'data': { 'path': 'str', 'queue': 'uint16', '*index': 'uint16' },
  'returns': 'VirtioQueueElement'
}
